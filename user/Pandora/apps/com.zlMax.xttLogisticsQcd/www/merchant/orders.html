<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>货运单</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/xtt.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/merchant.css" rel="stylesheet" />
	</head>

	<body>
		<div class="mui-content">
			<!--<div id="searchPanel">
				<div class="mui-input-row mui-search">
					<input id="searchInput" type="search" class="mui-input-clear" placeholder="输入关键字查询...">
				</div>
			</div>-->
			<div id="filter" class="filterorder mui-hidden">
				<!--<h5>查询结果过滤</h5>-->
				<form id="editForm" class="mui-input-group" style="margin-top: 0px;">
					<div class="mui-input-row">
						<a id="btnSelectLine" class="">
							<label>
								物流班次
							</label>
							<input type="text" readonly placeholder="请选择班次..." id="lineId" name="LineId">
							<a class="mui-btn mui-btn-warning float-btn btn-clear">清除</a>
						</a>
					</div>
					<div class="mui-input-row">
						<a id="btnLinePoint" class="">
							<label>送货片区</label>
							<input type="text" readonly placeholder="请选择送货片区..." name="OutletId" id="OutletId">
						</a>
						<a class="mui-btn mui-btn-warning float-btn btn-clear">清除</a>
					</div>

					<div class="mui-input-row">
						<a id="btnSelectSender" class="">
							<label>
								发货商户
							</label>
							<input type="text" readonly placeholder="请选择发货商户..." id="SendId" name="SendId">
							<a class="mui-btn mui-btn-warning float-btn btn-clear">清除</a>
						</a>
					</div>
					<div class="mui-input-row">
						<a id="btnSelectReceiver" class="">
							<label>收货商户</label>
							<input type="text" readonly placeholder="请选择收货商户..." name="ReceiveId" id="ReceiveId">
						</a>
						<a class="mui-btn mui-btn-warning float-btn btn-clear">清除</a>
					</div>
					<div class="mui-input-row">
						<a id="btnSelectAccount" class="">
							<label>开单账户</label>
							<input type="text" readonly placeholder="请选择开单账户..." name="AccountId" id="AccountId">
						</a>
						<a class="mui-btn mui-btn-warning float-btn btn-clear">清除</a>
					</div>
					<div class="multi-input-row date-from-to">
						<div class="col-6">
							<div class="mui-input-row">
								<a id="btnStartDate" class="">
									<label>开始</label>
									<input type="text" readonly placeholder="请选择开始日期..." name="StartDate" id="startDate">
									<a id="btnTodayStart" class="mui-btn mui-btn-primary float-btn btn-today">今</a>
								</a>
							</div>
						</div>
						<div class="col-6">
							<div class="mui-input-row">
								<a id="btnEndDate" class="">
									<label>结束</label>
									<input type="text" readonly placeholder="请选择结束日期..." name="EndDate" id="endDate">
									<a id="btnTodayEnd" class="mui-btn mui-btn-primary float-btn btn-today">今</a>
								</a>
							</div>
						</div>
					</div>
					<div class="multi-input-row">
						<input type="hidden" id="DptIds" name="DptIds" value="af64a2f4-68c0-4383-a9d1-aa91bd8fdecc,bdc7c869-1e6e-484c-b3c1-5af89d1f21dd," />
						<div class="col-4">
							<div class="mui-input-row mui-checkbox">
								<label style="padding-right: 0;">全城达</label>
								<input style="right: 0;" name="Part_QCD" id='Part_QCD' data-="af64a2f4-68c0-4383-a9d1-aa91bd8fdecc" checked value="true" type="checkbox">
							</div>
						</div>
						<div class="col-4">
							<div class="mui-input-row mui-checkbox">
								<label style="padding-right: 0;">佳峰城</label>
								<input style="right: 0;" name="Part_JFC" id='Part_JFC' data-="bdc7c869-1e6e-484c-b3c1-5af89d1f21dd" checked value="true" type="checkbox">
							</div>
						</div>

					</div>
					<div class="multi-input-row">
						<div class="col-3">
							<div class="mui-input-row mui-checkbox">
								<label style="padding-right: 0;">我的</label>
								<input style="right: 0;" name="onlyMe" id='onlyMe' value="false" type="checkbox">
							</div>
						</div>
						<div class="col-3">
							<div class="mui-input-row mui-checkbox">
								<label style="padding-right: 0;">代收</label>
								<input style="right: 0;" name="onlyNeedMemberPay" id='onlyNeedMemberPay' value="false" type="checkbox">
							</div>
						</div>
						<div class="col-3">
							<div class="mui-input-row mui-checkbox">
								<label style="padding-right: 0;">未付</label>
								<input style="right: 0;" name="onlyNoPay" id='onlyNoPay' value="false" type="checkbox">
							</div>
						</div>
						<div class="col-3">
							<div class="mui-input-row mui-checkbox">
								<label style="padding-right: 0;">未接</label>
								<input style="right: 0;" name="onlyNoAccept" id='onlyNoAccept' value="false" type="checkbox">
							</div>
						</div>
					</div>

					<!--	<div class="line-point">
						<span data-="4749e146-4a2c-4041-9ea9-993f3cd40379" style="background-color: #ff9706; color: white; text-shadow: none;">龙岗</span>
						<span data-="ec161e01-0159-488b-9433-5843a19f8e65" style="background-color: #00cc11; color: white; text-shadow: none;">八卦岭</span>
						<span data-="b30141f5-e5cc-455e-9fe2-21deeb3781e1" style="background-color: #0088cc; color: white; text-shadow: none;">奥特城</span>
						<span data-="b864b17f-f570-46e3-b028-82fa16db894a" style="background-color: #ed61ff; color: white; text-shadow: none;">宝安</span><br/>
						<span data-="4d02dd91-2d03-48a0-9ca0-e8d9d926fd22" style="background-color: #00cc11; color: white; text-shadow: none;">龙华</span>
						<span data-="c142400c-a9be-4fd4-995b-3f972550e394" style="background-color: #ed61ff; color: white; text-shadow: none;">沙井</span>
						<span data-="1a8dd1f0-5513-4f48-b6a7-06defbf53fad" style="background-color: #cfc921; color: white; text-shadow: none;">沙朗</span>
						<span data-="9c2d0ff4-4f53-4c34-8ade-5d5c48aa3bdb" style="background-color: #f01111; color: white; text-shadow: none;">江门</span>
					</div>-->
				</form>
				<div class="mui-input-row mui-search">
					<input id="searchInput" type="search" class="mui-input-clear" placeholder="输入关键字查询...">
				</div>
				<div class="mui-button-row">
					<button id="btnFilter" type="button" style="width:49%;height:55px;" class="mui-btn mui-btn-primary">
						普通筛选
					</button>
					<button id="btnStatFilter" type="button" style="width:49%;height:55px;" class="mui-btn mui-btn-primary">
						统计筛选
					</button>
				</div>
			</div>
			<div id="stPanel">
				<div id="stat">
				</div>
				<span id="statInfo" class="mui-icon mui-icon-info-filled"></span>
				<a id="btnShowFilter" class="mui-pull-right">查找</a>
			</div>
		</div>
		<div id="loadDiv" class="mui-loader">
			<span class="mui-spinner"></span>
			<br/> 加载中...
			<br/>
			<span id="loadingLabel" style="font-size: 10px;">正在加载货运单列表</span>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/zepto-1.1.6.min.js"></script>
		<script src="../js/xtt.js"></script>
		<script type="text/javascript" charset="utf-8">
			var listStyle = {
				top: '2px',
				bottom: '41px'
			};
			var listFilterStyle = {
				top: '38px',
				//bottom: '38px'
				height: 0
					//bottom: '333px'
			};
			//启用双击监听
			mui.init({
				gestureConfig: {
					doubletap: true
				}
				//        ,
				//        subpages: [{
				//            url: 'list-orders.html',
				//            id: 'list-orders.html',
				//            styles: {
				//                top: '38px',
				//                bottom: '38px'
				//            }
				//        }]
			});
			var self, sub;
			mui.plusReady(function() {
				self = plus.webview.currentWebview();
				sub = plus.webview.getWebviewById('list-orders.html');
				if(!sub) {
					sub = plus.webview.create('list-orders.html', 'list-orders.html', listStyle);
				}
				self.append(sub);
				mui.later(function() {
					mui.preload({
						id: 'merchant-order',
						url: 'order.html'
					});
					mui.preload({
						id: 'merchant-selectLine',
						url: 'selectLine.html'
					});
					mui.preload({
						id: 'merchant-orderPay',
						url: 'orderPay.html'
					});
					mui.preload({
						id: 'customerEdit',
						url: 'customer.html'
					});
					mui.preload({
						id: 'merchant-selectAccount',
						url: 'selectAccount.html'
					});
				}, 200);
				$("#loadDiv").addClass('mui-hidden');
			});
			//新增
			function add() {
				if(sub)
					mui.fire(sub, 'add');
			}

			function moreAction() {
				if(sub)
					mui.fire(sub, 'moreAction');
			}

			function setOrderStat(e) {
				var orderStat = e.detail.OrderStat;
				if(orderStat) {
					$('#stat').html('运费: <span id="sumFee">' + orderStat.SumFee.toFixed(2) + '</span> ' +
						'单数: <span id="SumOrderQuantity">' + orderStat.SumOrderQuantity + '</span> ' +
						'件数: <span id="sumGoodsQuantity">' + orderStat.SumGoodsQuantity + '</span> ' +
						'<br />总货款: <span id="SumMemberPayFee">' + orderStat.SumMemberPayFee.toFixed(2) + '</span> ' +
						'需代收:<span id="SumNeedMemberPayFee">' + orderStat.SumNeedMemberPayFee + '</span>(<span id="SumNeedMemberPayQuantity">' + orderStat.SumNeedMemberPayQuantity + '</span>)'
					)
				}
			}
			//新增事件
			document.addEventListener('add', add);
			document.addEventListener('moreAction', moreAction);
			document.addEventListener('setOrderStat', setOrderStat);
			//查询
			var searchInput = $('#searchInput');

			function search(type) {
				var keyword = searchInput.val().trim();
				//if(keyword && keyword != '')
				mui.fire(sub, 'search', {
					Keyword: keyword,
					StartDateTime: startDate.val(),
					EndDateTime: endDate.val(),
					LineId: lineId.attr('data-'),
					OutletId: outletId.attr('data-'),
					SearchType: type,
					OnlyMe: onlyMe.val(),
					OnlyNeedMemberPay: onlyNeedMemberPay.val(),
					OnlyNoPay: onlyNoPay.val(),
					OnlyNoAccept: onlyNoAccept.val(),
					SendId: SendId.attr('data-'),
					ReceiveId: ReceiveId.attr('data-'),
					AccountId: AccountId.attr('data-'),
					DptIds: $('#DptIds').val(),
				});
			}
			//绑定查询事件
			document.getElementById('searchInput').addEventListener('search', function() {
				search('1'); //普通查询
			});
			/*document.getElementById('searchInput').addEventListener('search', function() {
				search('2'); //统计查询
			});*/
			document.getElementById('btnFilter').addEventListener('tap', function() {
				//关闭过滤
				switchFilter();
				search('1');
			});
			document.getElementById('btnStatFilter').addEventListener('tap', function() {
				//关闭过滤
				switchFilter();
				search('2');
			});
			var showFilter = false;
			var filterDiv = $('#filter');

			function switchFilter() {
				//alert('filter');
				if(!sub || !self)
					return;
				//    return;
				//alert(showFilter);
				if(showFilter) {
					//					if (mui.os.android)
					//						self.remove(sub);
					//					sub.setStyle(listStyle);
					//					if (mui.os.android)
					//						self.append(sub);
					//					filterDiv.addClass('mui-hidden');
					//					showFilter = false;
					//					sub.setStyle({
					//						mask: "none"
					//					}); //移除menu的mask
					sub.show();
					filterDiv.addClass('mui-hidden');
					showFilter = false;
					$('#btnShowFilter').html('查找');
				} else {
					//					if (mui.os.android)
					//						self.remove(sub);
					//					sub.setStyle(listFilterStyle);
					//					if (mui.os.android)
					//						self.append(sub);
					//					filterDiv.removeClass('mui-hidden');
					//					sub.setStyle({
					//						mask: 'rgba(254,254,254,1)',
					//						//background:'white',
					//						//bottom: '50%',
					//						transition: {
					//							duration: 150
					//						}
					//					});
					sub.hide();
					filterDiv.removeClass('mui-hidden');
					showFilter = true;
					$('#btnShowFilter').html('收起');
				}
			}
			document.getElementById('stPanel').addEventListener('tap', switchFilter);
			var dDate = new Date();
			var todayStr = dDate.getFullYear() + '-' + (dDate.getMonth() + 1) + '-' + dDate.getDate();
			var minDate = new Date();
			minDate.setFullYear(2015, 4, 15);
			var maxDate = new Date();
			maxDate.setFullYear(2030, 4, 15);
			var lineId = $('#lineId');
			var onlyMe = $('#onlyMe');
			var onlyNeedMemberPay = $('#onlyNeedMemberPay');
			var onlyNoPay = $('#onlyNoPay');
			var onlyNoAccept = $('#onlyNoAccept');
			var startDate = $('#startDate');
			var endDate = $('#endDate');
			var outletId = $('#OutletId');
			var AccountId = $('#AccountId');
			var SendId = $('#SendId');
			var ReceiveId = $('#ReceiveId');
			//document ready
			Zepto(function($) {
				startDate.val(todayStr);
				endDate.val(todayStr);
			});

			function getDateFromString(dStr) {
				var arr = dStr.split('-');
				var d = new Date;
				if(arr.length > 2) {
					d.setFullYear(parseInt(arr[0]), parseInt(arr[1] - 1), parseInt(arr[2]));
				}
				return d;
			}

			function selStartDate() {
				var ds = getDateFromString(startDate.val());
				plus.nativeUI.pickDate(function(e) {
					var d = e.date;
					startDate.val(d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate());
				}, function(e) {
					//info.innerText = "您没有选择日期";
				}, {
					title: "请选择开始日期",
					date: ds,
					minDate: minDate,
					maxDate: maxDate
				});
			}

			function selEndDate() {
				var ds = getDateFromString(endDate.val());
				plus.nativeUI.pickDate(function(e) {
					var d = e.date;
					endDate.val(d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate());
				}, function(e) {
					//info.innerText = "您没有选择日期";
				}, {
					title: "请选择开始日期",
					date: ds,
					minDate: minDate,
					maxDate: maxDate
				});
			}
			document.getElementById('btnStartDate').addEventListener('tap', selStartDate);
			document.getElementById('btnEndDate').addEventListener('tap', selEndDate);
			document.getElementById('btnTodayStart').addEventListener('tap', function() {
				var d = new Date();
				startDate.val(d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate());
			});
			document.getElementById('btnTodayEnd').addEventListener('tap', function() {
				var d = new Date();
				endDate.val(d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate());
			});

			function test() {
				var list = plus.webview.getWebviewById('order_list.html');
				if(list)
					mui.fire(list, 'setOption', {});
			}
			//选择班次
			document.getElementById('lineId').addEventListener('tap', function() {
				mui.fire(
					plus.webview.getWebviewById('merchant-selectLine'),
					'setBack', {
						backId: plus.webview.currentWebview().id
					}
				);
				mui.openWindow({
					url: "selectLine.html",
					id: "merchant-selectLine",
					show: {
						aniShow: 'pop-in',
						duration: 300
					}
				});
			});
			//班次选择完成
			document.addEventListener("lineSelected", function(e) {
				var line = e.detail;
				lineId.val(line.Name);
				lineId.attr('data-', line.LineId);
			});
			//选择区域
			document.getElementById('OutletId').addEventListener('tap', function() {
				mui.fire(
					plus.webview.getWebviewById('merchant-selectOutlet'),
					'setBack', {
						backId: plus.webview.currentWebview().id
					}
				);
				mui.openWindow({
					url: "selectOutlet.html",
					id: "merchant-selectOutlet",
					show: {
						aniShow: 'pop-in',
						duration: 300
					}
				});
			});
			//区域选择完成
			document.addEventListener("outletSelected", function(e) {
				var outlet = e.detail;
				outletId.val(outlet.Name);
				outletId.attr('data-', outlet.Id);
			});
			//选择开单帐户
			document.getElementById('AccountId').addEventListener('tap', function() {
				mui.fire(
					plus.webview.getWebviewById('merchant-selectAccount'),
					'setBack', {
						backId: plus.webview.currentWebview().id
					}
				);
				mui.openWindow({
					url: "selectAccount.html",
					id: "merchant-selectAccount",
					show: {
						aniShow: 'pop-in',
						duration: 300
					}
				});
			});
			//开单帐户选择完成
			document.addEventListener("AccountSelected", function(e) {
				var accountId = e.detail;
				AccountId.val(accountId.UserName);
				AccountId.attr('data-', accountId.MemberID);
			});

			mui('#editForm').on('tap', '.btn-clear', function(e) {
				var ipt = $(this).parent().find('input');
				ipt.val('');
				ipt.attr('data-', '');
			});

			document.getElementById('SendId').addEventListener('tap', function() {
				mui.fire(
					plus.webview.getWebviewById('merchant-selectCustomer-sender'),
					'setBack', {
						backId: plus.webview.currentWebview().id,
						lineId: lineId.attr('data-'),
						from: 'Sender'
					}
				);
				mui.openWindow({
					url: "selectCustomer.html",
					id: "merchant-selectCustomer-sender",
					show: {
						aniShow: 'pop-in',
						duration: 300
					}
				});
			});
			document.getElementById('ReceiveId').addEventListener('tap', function() {
				mui.fire(
					plus.webview.getWebviewById('merchant-selectCustomer-receiver'),
					'setBack', {
						backId: plus.webview.currentWebview().id,
						lineId: lineId.attr('data-'),
						from: 'Receiver'
					}
				);
				mui.openWindow({
					url: "selectCustomer.html",
					id: "merchant-selectCustomer-receiver",
					show: {
						aniShow: 'pop-in',
						duration: 300
					}
				});
			});

			document.addEventListener("customerSelected", function(e) {
				var customer = e.detail.customer;
				var from = e.detail.from;
				if(from == 'Sender') {
					SendId.val(customer.ShortName);
					SendId.attr('data-', customer.Id);
				} else {
					ReceiveId.val(customer.ShortName + '[' + customer.LineName + ']');
					ReceiveId.attr('data-', customer.Id);
				}
			});

			/*mui('#editForm').on('tap', 'span', function(e) {
				carCityId.val($(this).html());
				carCityId.attr('data-', $(this).attr('data-'))
					/*	$(this).parent().find('input').val('');		
			});*/
			mui('.mui-checkbox').on('change', 'input', function() {
				if($(this).attr('name') == 'Part_QCD' || $(this).attr('name') == 'Part_JFC') {
					if(this.checked) {
						$('#DptIds').val($('#DptIds').val() + $(this).attr('data-') + ',');
					} else {
						var ids = $('#DptIds').val();
						if(ids.indexOf($(this).attr('data-') + ',') >= 0) {
							ids = ids.replace($(this).attr('data-') + ',', '');
							$('#DptIds').val(ids);
						}
					}
					//alert($('#DptIds').val());
				} else {
					$(this).val(this.checked);
				}
			});
			//列表滚动到顶部
			function scroll2Top() {
				if(sub)
					mui.fire(sub, 'scroll2Top');
			}
			document.addEventListener('scroll2Top', scroll2Top);
		</script>
	</body>

</html>